// Prisma schema for Grocery/Food Ecommerce (Fruits, Vegetables, Milk, etc.)

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum DiscountType {
  PERCENTAGE
  FIXED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReferenceType {
  ORDER
  RETURN
  ADJUSTMENT
  PURCHASE
  MANUAL
}

enum InventoryChangeType {
  INCREASE
  DECREASE
  MANUAL_ADJUSTMENT
  SALE
  RETURN
  CANCEL
  RESTOCK
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  UNPAID
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  COD
  ONLINE
  UPI
  CARD
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  SAME_DAY
}

enum CouponType {
  PERCENTAGE
  FIXED
}

enum CouponStatus {
  ACTIVE
  EXPIRED
  INACTIVE
}

enum InStock {
  AVILABLE
  FEWAVILABLE
  OUTOFSTCOK
}

// MODELS

model User {
  id           String    @unique @default(uuid())
  user_id      Int       @id @default(autoincrement())
  name         String
  email        String    @unique
  password     String
  salt         String
  phone        String?
  refreshToken String?
  Otp          String?
  is_verified  Boolean? @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  profile             Profile?
  ProductReview       ProductReview[]
  Wishlist            Wishlist[]
  ProductInventoryLog ProductInventoryLog[] @relation("UserChangedLogs")

  Order Order[]

  CouponRedemption CouponRedemption[]
}

model Profile {
  id         String    @unique @default(uuid())
  profile_id Int       @id @default(autoincrement())
  user_id    Int       @unique
  avatar     String?
  address    String?
  city       String?
  state      String?
  zip_code   String?
  country    String?
  user       User      @relation(fields: [user_id], references: [user_id])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
}

model Category {
  id         String    @unique @default(uuid())
  category_id Int       @id @default(autoincrement())
  name        String
  slug        String?   @unique
  description String?
  products    Product[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model Unit {
  unit_id   Int      @id @default(autoincrement())
  name      String   @unique
  short     String
  createdAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  products        Product[]
  productVariants ProductVariant[]
  
}

model Product {
  id           String   @unique @default(uuid())
  product_id   Int      @id @default(autoincrement())
  name         String
  slug         String?  @unique
  description  String?
  sku          String?  @unique
  price        Float
  stock        Int      @default(0)
  isVisible    Boolean  @default(true)
  isFeatured   Boolean  @default(false)
  isPerishable Boolean  @default(false)
  expiryDays   Int?
  inStock      InStock? 
  category_id  Int
  unit_id      Int
  category     Category @relation(fields: [category_id], references: [category_id])
  unit         Unit     @relation(fields: [unit_id], references: [unit_id])
  reviews       ProductReview[]
  tags          ProductTag[]
  discounts     ProductDiscount[]
  seo           ProductSEO?
  wishlists     Wishlist[]
  inventoryLogs ProductInventoryLog[]
  variants      ProductVariant[]
  images        ProductImage[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  OrderItem OrderItem[]
}
//variance like 1 kg na 10 stock ma che
model ProductVariant {
  id           String   @unique @default(uuid())
  variant_id   Int      @id @default(autoincrement())
  product_id Int
  name       String      // e.g., "500ml", "1kg"
  unit_id    Int
  sku        String @unique
  price      Float
  stock      Int     @default(0)

  product    Product @relation(fields: [product_id], references: [product_id])
  unit       Unit    @relation(fields: [unit_id], references: [unit_id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  OrderItem OrderItem[]
}

model ProductImage {
  id         Int      @id @default(autoincrement())
  product_id Int
  url        String
  altText    String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [product_id], references: [product_id])
}

model ProductInventoryLog {
  id                String              @unique @default(uuid())
  inventory_log_id  Int                 @id @default(autoincrement())
  product_id        Int
  variant_id        String?
  changeType        InventoryChangeType
  quantityChanged   Int
  stockBeforeChange Int
  stockAfterChange  Int
  changed_by        Int
  referenceType     ReferenceType
  referenceId       String
  remarks           String?
  timestamp         DateTime            @default(now())

  product   Product @relation(fields: [product_id], references: [product_id])
  changedBy User    @relation("UserChangedLogs", fields: [changed_by], references: [user_id])
}

model ProductDiscount {
  id                  String       @unique @default(uuid())
  product_discount_id Int          @id @default(autoincrement())
  product_id          Int
  discountType        DiscountType
  discountValue       Float
  startDate           DateTime
  endDate             DateTime
  createdAt           DateTime     @default(now())
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [product_id], references: [product_id])
}

model ProductReview {
  id                String       @unique @default(uuid())
  product_review_id Int          @id @default(autoincrement())
  product_id        Int
  user_id           Int
  rating            Int
  reviewText        String
  status            ReviewStatus @default(PENDING)
  createdAt         DateTime     @default(now())
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [product_id], references: [product_id])
  user    User    @relation(fields: [user_id], references: [user_id])
}

model Tag {
  tag_id   Int          @id @default(autoincrement())
  name     String       @unique
  products ProductTag[]
}

model ProductTag {
  product_tag_id String  @id @default(uuid())
  product_id     Int
  tag_id         Int
  product        Product @relation(fields: [product_id], references: [product_id])
  tag            Tag     @relation(fields: [tag_id], references: [tag_id])
}

model ProductSEO {
  id             String @unique @default(uuid())
  product_seo_id Int    @id @default(autoincrement())

  product_id      Int    @unique
  metaTitle       String
  metaDescription String
  keywords        String

  product Product @relation(fields: [product_id], references: [product_id])
}

model Wishlist {
  uuid        String   @unique @default(uuid())
  wishlist_id Int      @id @default(autoincrement())
  user_id     Int
  product_id  Int
  addedAt     DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [user_id])
  product Product @relation(fields: [product_id], references: [product_id])
}



model Order {
  id             String         @unique @default(uuid())
  order_id       Int            @id @default(autoincrement())
  user_id        Int
  coupon_id      Int?
  totalAmount    Float
  discount       Float?          @default(0)
  tax            Float?          @default(0)
  shippingCost   Float?          @default(0)
  grandTotal     Float?
  status         OrderStatus   @default(PENDING)
  paymentStatus  PaymentStatus  @default(UNPAID)
  paymentMethod  PaymentMethod?
  shippingMethod ShippingMethod?
  placedAt       DateTime       @default(now())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  cancelledAt    DateTime?
  deliveredAt    DateTime?

  user           User           @relation(fields: [user_id], references: [user_id])
  coupon         Coupon?        @relation(fields: [coupon_id], references: [coupon_id])
  items          OrderItem[]
  payment        OrderPayment?
  redemptions    CouponRedemption[]
}

model OrderItem {
  id            String          @unique @default(uuid())
  order_item_id Int             @id @default(autoincrement())
  order_id      Int
  product_id    Int
  variant_id    Int?            // must match type in ProductVariant
  quantity      Int?
  price         Float?          // price per unit
  total         Float?          // quantity * price

  order         Order           @relation(fields: [order_id], references: [order_id])
  product       Product         @relation(fields: [product_id], references: [product_id])
  variant       ProductVariant? @relation(fields: [variant_id], references: [variant_id])
}

model OrderPayment {
  id            String        @unique @default(uuid())
  payment_id    Int           @id @default(autoincrement())
  order_id      Int           @unique
  transactionId String?
  amount        Float
  method        PaymentMethod
  status        PaymentStatus
  paidAt        DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  

  order         Order         @relation(fields: [order_id], references: [order_id])
}

model Coupon {
  id             String         @unique @default(uuid())
  coupon_id      Int            @id @default(autoincrement())
  code           String?         @unique
  description    String?
  type           CouponType
  value          Float?
  minOrderValue  Float?         @default(0)
  maxDiscount    Float?
  usageLimit     Int?
  usedCount      Int            @default(0)
  perUserLimit   Int?
  validFrom      DateTime?
  validTo        DateTime?
  status         CouponStatus?   @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  orders         Order[]
  redemptions    CouponRedemption[]
}

//user can used only one time cupon that perpose i have create this table
model CouponRedemption {
  id         String   @id @default(uuid())
  coupon_id  Int
  user_id    Int
  order_id   Int
  usedAt     DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  coupon     Coupon @relation(fields: [coupon_id], references: [coupon_id])
  user       User   @relation(fields: [user_id], references: [user_id])
  order      Order  @relation(fields: [order_id], references: [order_id])
}
